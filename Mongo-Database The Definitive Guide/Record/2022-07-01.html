<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.28.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.13.5/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.13.5"></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.13.5/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, root, jsonOptions) => {
        const markmap = getMarkmap();
        window.mm = markmap.Markmap.create('svg#mindmap', (getOptions || markmap.deriveOptions)(jsonOptions), root);
      })(() => window.markmap,null,{"type":"heading","depth":0,"payload":{"lines":[0,1]},"content":"PART 2 MongoDB 개발","children":[{"type":"heading","depth":1,"payload":{"lines":[2,3]},"content":"CHAPTER 2 인덱싱","children":[{"type":"heading","depth":2,"payload":{"lines":[4,5]},"content":"5.1 인덱싱 소개","children":[{"type":"bullet_list","depth":3,"payload":{"lines":[5,13]},"content":"","children":[{"type":"list_item","depth":4,"payload":{"lines":[5,6]},"content":"인덱스는 책의 인덱스와 유사하다."},{"type":"list_item","depth":4,"payload":{"lines":[6,7]},"content":"몽고는 전체 내용을 살펴보는 대신 인덱스를 통해 특정 내용을 가리키는 정렬된 리스트를 확인한다."},{"type":"list_item","depth":4,"payload":{"lines":[7,8]},"content":"엄청난 양의 명령을 더 빠르게 쿼리할 수 있다."},{"type":"list_item","depth":4,"payload":{"lines":[8,9]},"content":"수정하거나 쓸 때에는 더 많은 시간이 걸린다.","children":[{"type":"list_item","depth":5,"payload":{"lines":[9,10]},"content":"같은 컬렉션의 인덱스 정렬이 필요하기 때문이다."}]},{"type":"list_item","depth":4,"payload":{"lines":[10,11]},"content":"인덱스를 사용하지 않는 쿼리를 <code>Collection scan</code>이라 한다.","children":[{"type":"list_item","depth":5,"payload":{"lines":[11,12]},"content":"이는 서버가 쿼리 결과를 찾으려면 '전체 내용을 살펴봐야 함'을 의미한다."}]},{"type":"list_item","depth":4,"payload":{"lines":[12,13]},"content":"<code>.explain()</code>을 사용하면 쿼리 실행 과정을 볼 수 있다."}]},{"type":"heading","depth":3,"payload":{"lines":[13,14]},"content":"5.1.1 인덱스 생성","children":[{"type":"fence","depth":4,"content":"<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">></span> db<span class=\"token punctuation\">.</span><span class=\"token property-access\">user</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">createIndex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string-property property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</code></pre>\n"},{"type":"bullet_list","depth":4,"payload":{"lines":[17,19]},"content":"","children":[{"type":"list_item","depth":5,"payload":{"lines":[17,18]},"content":"컬렉션을 특히 크게 만들지 않는 한 인덱스는 몇 초면 충분하다."},{"type":"list_item","depth":5,"payload":{"lines":[18,19]},"content":""}]},{"type":"fence","depth":4,"content":"<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">></span> db<span class=\"token punctuation\">.</span><span class=\"token property-access\">user</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">explain</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"executionStats\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">{</span>\n        <span class=\"token string-property property\">\"queryPlanner\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string-property property\">\"plannerVersion\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"namespace\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"some.user\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"indexFilterSet\"</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"parsedQuery\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"winningPlan\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string-property property\">\"stage\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"COLLSCAN\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"direction\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"forward\"</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"rejectedPlans\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"executionStats\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string-property property\">\"executionSuccess\"</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"nReturned\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">105</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"executionTimeMillis\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"totalKeysExamined\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"totalDocsExamined\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">105</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"executionStages\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token string-property property\">\"stage\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"COLLSCAN\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"nReturned\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">105</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"executionTimeMillisEstimate\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"works\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">107</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"advanced\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">105</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"needTime\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"needYield\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"saveState\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"restoreState\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"isEOF\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"direction\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"forward\"</span><span class=\"token punctuation\">,</span>\n                        <span class=\"token string-property property\">\"docsExamined\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">105</span>\n                <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"serverInfo\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string-property property\">\"host\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"goorm\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"port\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">27017</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"version\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"4.4.14\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string-property property\">\"gitVersion\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"0b0843af97c3ec9d2c0995152d96d2aad725aab7\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"ok\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">1</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n"}]},{"type":"heading","depth":3,"payload":{"lines":[66,67]},"content":"5.1.2 복합 인덱스 소개","children":[{"type":"bullet_list","depth":4,"payload":{"lines":[67,70]},"content":"","children":[{"type":"list_item","depth":5,"payload":{"lines":[67,68]},"content":"인덱스는 가능한 한 효율적으로 쿼리하려는 목적으로 사용한다."},{"type":"list_item","depth":5,"payload":{"lines":[68,69]},"content":"인덱스는 모든 값을 정렬된 순서로 보관하므로 정렬 작업이 훨씬 빨라지게 된다."},{"type":"list_item","depth":5,"payload":{"lines":[69,70]},"content":"하지만 인덱스가 앞 부분에 놓일 때만 정렬에 도움된다."}]},{"type":"fence","depth":4,"content":"<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">></span> db<span class=\"token punctuation\">.</span><span class=\"token property-access\">users</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">find</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 이것은 age로 정렬 후 username으로 정렬하는데 완전 정렬은 별로 도움이 되지 않는다.</span>\n</code></pre>\n"},{"type":"bullet_list","depth":4,"payload":{"lines":[74,75]},"content":"","children":[{"type":"list_item","depth":5,"payload":{"lines":[74,75]},"content":"위 커맨드를 최적화 시키려면 <code>age</code>와 <code>username</code>에 인덱스를 만들어야 한다."}]},{"type":"fence","depth":4,"content":"<pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">></span> db<span class=\"token punctuation\">.</span><span class=\"token property-access\">users</span><span class=\"token punctuation\">.</span><span class=\"token method function property-access\">createIndex</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string-property property\">\"age\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string-property property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 이것은 두 개의 키를 인덱스로 만든다.</span>\n</code></pre>\n"},{"type":"bullet_list","depth":4,"payload":{"lines":[79,81]},"content":"","children":[{"type":"list_item","depth":5,"payload":{"lines":[79,80]},"content":"위를 <strong><em>복합 인덱스</em></strong>라고 표현한다."}]}]},{"type":"heading","depth":3,"payload":{"lines":[81,82]},"content":"5.1.3 몽고DB가 인덱스를 선택하는 방법","children":[{"type":"list_item","depth":4,"payload":{"lines":[82,83]},"content":"5개의 인덱스가 있다고 가정하자.","children":[{"type":"list_item","depth":5,"payload":{"lines":[83,84]},"content":"쿼리가 들어오면 몽고는 <strong><em>쿼리 모양(query shape)</em></strong>을 확인한다."},{"type":"list_item","depth":5,"payload":{"lines":[84,85]},"content":"모양은 검색할 필드와 정렬 여부 등 추가 정보와 관련 있다."},{"type":"list_item","depth":5,"payload":{"lines":[85,86]},"content":"정보를 기반으로 쿼리를 충족하는 데 사용할 인덱스 후보 집합을 식별한다."}]},{"type":"list_item","depth":4,"payload":{"lines":[86,87]},"content":"쿼리가 들어오고 인덱스 5개 중 3개가 쿼리 후보로 식별됐다고 가정하자."},{"type":"list_item","depth":4,"payload":{"lines":[87,88]},"content":"몽고는 각 인덱스 후보에 하나씩 총 3개의 <strong><em>쿼리 플랜(query plan)</em></strong>을 만든다."},{"type":"list_item","depth":4,"payload":{"lines":[88,89]},"content":"그리고 병렬 쓰레드에서 쿼리를 실행한다.","children":[{"type":"list_item","depth":5,"payload":{"lines":[89,90]},"content":"이 방법은 레이스와 유사하다."},{"type":"list_item","depth":5,"payload":{"lines":[90,91]},"content":"가장 먼저 목표 상태에 도달하는 쿼리 플랜이 승자가 된다."},{"type":"list_item","depth":5,"payload":{"lines":[91,92]},"content":"플랜은 <strong><em>일정 기간(trial period)</em></strong> 동안 서로 경쟁하며, 각 레이스의 결과로 전체 승리 플랜을 산출한다."}]},{"type":"list_item","depth":4,"payload":{"lines":[92,93]},"content":"승리한 쿼리 플랜은 향 후 같은 쿼리 모양에 사용되기 위하여 캐시에 저장 된다.","children":[{"type":"list_item","depth":5,"payload":{"lines":[93,94]},"content":"시간이 지나서 컬렉션과 인덱스가 변경되면 쿼리 플랜이 캐시에서 제거된다."},{"type":"list_item","depth":5,"payload":{"lines":[94,95]},"content":"몽고는 다시 가능한 쿼리 플랜을 실험해서 해당 컬렉션 및 인덱스 집합에 가장 적합한 플랜을 찾는다."},{"type":"list_item","depth":5,"payload":{"lines":[95,96]},"content":"인덱스를 추가하거나, 삭제하면 플랜이 캐시에서 제거된다."},{"type":"list_item","depth":5,"payload":{"lines":[96,97]},"content":"쿼리 플랜 캐시는 명시적으로도 지울 수 있다."},{"type":"list_item","depth":5,"payload":{"lines":[97,98]},"content":"<strong>mongod</strong> 프로세스를 다시 시작할 때에도 삭제된다."}]}]}]}]}]},{})</script>
</body>
</html>
